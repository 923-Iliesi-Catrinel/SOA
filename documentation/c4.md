# PharmaGuard Architecture Documentation

## 1. System Context Diagram (Level 1)

```mermaid
C4Context
    title System Context Diagram - PharmaGuard

    %% Actors
    Person(pharmacist, "Hospital Pharmacist", "Places orders for critical medicine.")
    Person(manager, "Logistics Manager", "Monitors fleet status and receives shock alerts.")
    System_Ext(truck_sensor, "IoT Sensor Box", "Hardware device in truck. Sends GPS, Temp, Vibration.")

    %% The Main System
    System(pharmaguard, "PharmaGuard System", "Microservices platform for logistics tracking, risk assessment, and order management.")

    %% External Systems
    System_Ext(email_client, "Manager's Email", "Receives critical alert emails.")

    %% Relationships
    Rel(pharmacist, pharmaguard, "1. Places Orders, Signs for delivery (HTTPS)")
    Rel(manager, pharmaguard, "2. Views Live Dashboard (WSS)")
    Rel(truck_sensor, pharmaguard, "3. Streams Telemetry Data (HTTP/MQTT)")
    Rel(pharmaguard, email_client, "4. Sends Critical Alerts (SMTP)")
```

## 2. Container Diagram (Level 2)

```mermaid
C4Container
    title Container Diagram - PharmaGuard Architecture

    Person(user, "User", "Pharmacist or Manager")

    Container(spa, "Dashboard SPA", "React.js / Leaflet", "Frontend UI. Visualizes trucks and alerts.")

    %% GATEWAY
    Container(nginx, "API Gateway", "NGINX", "Load Balancer. Routes traffic & handles Sticky Sessions (ip_hash).")

    %% MICROSERVICES
    Container(auth_svc, "Auth Service", "Node.js / Express", "JWT Authentication.")
    Container(order_svc, "Order Service", "Node.js / Express", "Order Management logic.")
    Container(telemetry_svc, "Telemetry Service", "Node.js / Kafka Producer", "Ingests raw sensor data.")
    Container(notif_svc, "Notification Service", "Node.js / Socket.IO", "Scaled Cluster (x2 Replicas). Broadcasts alerts.")

    %% INFRASTRUCTURE
    Container(kafka, "Kafka", "Apache Kafka", "Telemetry Streaming.")
    Container(rabbitmq, "RabbitMQ", "Message Broker", "Order events.")
    Container(faas_risk, "Risk FaaS", "Node.js Function", "Calculates loss.")
    Container(faas_email, "Email FaaS", "Node.js Function", "Sends emails.")

    %% DATABASES
    ContainerDb(pg_auth, "Auth DB", "PostgreSQL", "User Data")
    ContainerDb(pg_order, "Order DB", "PostgreSQL", "Order Data")
    ContainerDb(pg_telem, "Telemetry DB", "PostgreSQL", "Sensor Logs")
    ContainerDb(redis, "Redis Backplane", "Redis Pub/Sub", "Syncs socket events across replicas.")

    %% FLOWS
    %% User calls Dashboard directly
    Rel(user, spa, "Uses (HTTPS)")

    %% Dashboard calls Gateway
    Rel(spa, nginx, "API Calls / WSS")

    %% Gateway Routes to Services
    Rel(nginx, auth_svc, "/api/auth")
    Rel(nginx, order_svc, "/api/orders")
    Rel(nginx, telemetry_svc, "/api/telemetry")
    Rel(nginx, notif_svc, "/socket.io (Sticky)")

    %% Services use Databases
    Rel(auth_svc, pg_auth, "Read/Write")
    Rel(order_svc, pg_order, "Read/Write")
    Rel(telemetry_svc, pg_telem, "Archives data")

    %% Services use Messaging
    Rel(order_svc, rabbitmq, "Publishes events")
    Rel(telemetry_svc, kafka, "Produces stream")
    Rel(notif_svc, kafka, "Consumes stream")
    Rel(notif_svc, rabbitmq, "Consumes events")
    Rel(notif_svc, redis, "Syncs Cluster")

    %% Notification Service calls FaaS
    Rel(notif_svc, faas_risk, "Triggers (HTTP)")
    Rel(notif_svc, faas_email, "Triggers (HTTP)")

    %% Notification Service pushes to Frontend
    Rel(notif_svc, spa, "Push Alert (WebSocket)")
```

## 3. Component Diagram: Notification Service (Level 3)

```mermaid
C4Component
    title Component Diagram - Notification Service (Node.js)

    Container(kafka, "Kafka", "Streaming Platform")
    Container(redis, "Redis", "Pub/Sub Backplane")
    Container(faas, "FaaS Functions", "Risk & Email")
    Container(spa, "React Frontend", "Browser")

    Container_Boundary(notif_app, "Notification Service") {
        Component(socket_server, "Socket.IO Server", "Library", "Manages WebSocket connections.")
        Component(redis_adapter, "Redis Adapter", "@socket.io/redis-adapter", "Intercepts emits and broadcasts to Redis.")
        Component(kafka_consumer, "Kafka Consumer", "KafkaJS", "Listens to 'telemetry-stream' topic.")
        Component(logic, "Alerts", "JS Function", "Checks thresholds (Temp > 8Â°C). Filters spam.")
        Component(http_client, "FaaS Client", "Axios", "Triggers external risk functions.")
    }

    %% Relationships
    Rel(kafka, kafka_consumer, "Pushes Data")
    Rel(kafka_consumer, logic, "Passes Truck Data")

    Rel(logic, http_client, "If Critical")
    Rel(http_client, faas, "POST Request")

    Rel(logic, socket_server, "Emit 'notification'")
    Rel(socket_server, redis_adapter, "Passes message")
    Rel(redis_adapter, redis, "PUBLISH / SUBSCRIBE")

    Rel(socket_server, spa, "Delivers Event")
```

## 4. Data Model (UML Class Diagram)

```mermaid
erDiagram
    USERS {
        UUID id PK
        string username
        string password_hash
        string role "MANAGER | PHARMACIST"
    }

    ORDERS {
        UUID id PK
        string productName
        int quantity
        string status "PENDING | SHIPPED"
        string createdBy "Refers to Users.username"
        string truckId "Logical Link to Fleet"
        timestamp createdAt
        timestamp updatedAt
    }

    TELEMETRY_LOGS {
        UUID id PK
        string truckId
        float latitude
        float longitude
        float temperature
        float vibration "Threshold > 4.0G = Crash"
        timestamp timestamp
    }

    USERS ||--o{ ORDERS : "places (via createdBy)"

    %% Logical Relationship: An Order is assigned to a Truck,
    %% and that Truck produces many Telemetry Logs.
    ORDERS }|..|{ TELEMETRY_LOGS : "linked by truckId"
```
